<html>
  <head>
    <title>Snake Neural Network</title>
    <script src="Snake.js"></script>
  </head>

  <body>
    <script>
      let snakeGame = new Snake(200, 10);
      let reward = null;

      let stateLength = snakeGame.stateLength;
      let actionNum = snakeGame.actionNum;
      let data = { stateLength, actionNum };
      let options = {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(data)
      };

      fetch("/initialize", options);

      let intervalID = setInterval(updateGame, snakeGame.updateTime);

      function updateGame() {
        let state = snakeGame.getState();
        data = { state, reward };
        options.body = JSON.stringify(data);
        fetch("/action", options)
          .then(response => {
            return response.json();
          })
          .then(data => {
            if (snakeGame.alive) {
              let action = data.action;
              snakeGame.doAction(action);
              reward = snakeGame.update();
            } else {
              fetch("/train", options).then(response => {
                clearInterval(intervalID);
                snakeGame.restart();
                newInterval();
              });
            }
          });
      }

      function newInterval() {
        intervalID = setInterval(updateGame, snakeGame.updateTime);
      }

      window.addEventListener("unload", function(event) {
        fetch("/exit", options);
      });
    </script>
  </body>
</html>
